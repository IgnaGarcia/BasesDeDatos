------------------Inicio script -------------------------------------------
DROP TABLE IF EXISTS FACTURAS CASCADE;
DROP TABLE IF EXISTS CLIENTES CASCADE;
DROP TABLE IF EXISTS VENDEDORES CASCADE;
DROP TABLE IF EXISTS DEPARTAMENTOS CASCADE;
DROP TABLE IF EXISTS PROVEEDORES CASCADE;
DROP TABLE IF EXISTS ENTREGAS CASCADE;
DROP TABLE IF EXISTS ARTICULOS CASCADE;
DROP TABLE IF EXISTS CONTIENE CASCADE;
--
CREATE TABLE CLIENTES
(CodC	INTEGER        	NOT NULL,
 NombC	VARCHAR(20)    	NOT NULL,
 SexoC	CHAR(1)        	NOT NULL,
 Localidad VARCHAR(20),
 CONSTRAINT Pk_Clientes PRIMARY KEY(CodC));

CREATE TABLE VENDEDORES
(CodV	INTEGER    	NOT NULL,
 NombV	VARCHAR(20) NOT NULL,
 SexoV	CHAR(1)    	NOT NULL,
 FnacV 	DATE     	NOT NULL,
 CONSTRAINT Pk_Vendedores PRIMARY KEY(CodV));

CREATE TABLE DEPARTAMENTOS
(CodD	INTEGER    	NOT NULL,
 NombD	VARCHAR(30) NOT NULL,
 Rubro	VARCHAR(20)	NOT NULL,
 CONSTRAINT Pk_Departamentos PRIMARY KEY(CodD));

CREATE TABLE PROVEEDORES
(Cuit	CHAR(11)    	NOT NULL,
 NombP	VARCHAR(30) 	NOT NULL,
 Direc	VARCHAR(35),
 Localidad VARCHAR(20),
 CONSTRAINT Pk_Proveedores PRIMARY KEY(Cuit));

CREATE TABLE ARTICULOS
(CodA    	INTEGER 	NOT NULL,
 NombA  	VARCHAR(25) NOT NULL,
 Precio 	INTEGER    	NOT NULL,
 Stock  	INTEGER,
 StockMin   INTEGER    	NOT NULL,
 StockMax   INTEGER    	NOT NULL,
 CodD    	INTEGER 	NOT NULL,
 CONSTRAINT Pk_Articulos PRIMARY KEY(CodA),
 CONSTRAINT Fk_Articulos_Departamentos FOREIGN KEY(CodD) REFERENCES DEPARTAMENTOS(CodD) ON DELETE NO ACTION);

CREATE TABLE ENTREGAS
(CodA    	INTEGER    	NOT NULL,
 Cuit    	CHAR(11)    	NOT NULL,
 FechaE    	DATE    	NOT NULL,
 PrecioAdq	INTEGER    	NOT NULL,
 CantE    	INTEGER    	NOT NULL,
 CONSTRAINT Pk_Entregas PRIMARY KEY(CodA, Cuit, FechaE),
 CONSTRAINT Fk_Entregas_Proveedores FOREIGN KEY(Cuit) REFERENCES PROVEEDORES(Cuit) ON DELETE NO ACTION,
 CONSTRAINT Fk_Entregas_Articulos FOREIGN KEY(CodA) REFERENCES ARTICULOS(CodA) ON DELETE NO ACTION);

CREATE TABLE FACTURAS
(CodF	INTEGER    	NOT NULL,
 CodC	INTEGER    	NOT NULL,
 CodV	INTEGER    	NOT NULL,
 FechaV	DATE    	NOT NULL,
 CONSTRAINT Pk_Facturas PRIMARY KEY(CodF),
 CONSTRAINT Fk_Facturas_Clientes FOREIGN KEY(CodC) REFERENCES CLIENTES(CodC) ON DELETE NO ACTION,
 CONSTRAINT Fk_Facturas_Vendedores FOREIGN KEY(CodV) REFERENCES VENDEDORES(CodV) ON DELETE NO ACTION);
   	 
CREATE TABLE CONTIENE
(CodA    	INTEGER 	NOT NULL,
 CodF    	INTEGER 	NOT NULL,
 PrecioVent INTEGER    	NOT NULL,
 Cant    	INTEGER 	NOT NULL,
 CONSTRAINT Pk_Contiene PRIMARY KEY(CodA, CodF),
 CONSTRAINT Fk_Contiene_Articulo FOREIGN KEY(CodA) REFERENCES ARTICULOS(CodA) ON DELETE NO ACTION,
 CONSTRAINT Fk_Contiene_Factura FOREIGN KEY(CodF) REFERENCES FACTURAS(CodF) ON DELETE NO ACTION);
--
-- INSERT INTO de Datos
--
--   -> INSERTS CLIENTES (*CodC, NombC, SexoC, Localidad)
BEGIN TRANSACTION;
INSERT INTO CLIENTES VALUES (7001,'Gustavo Fernandez', 'H', 'Ituzaingó');
INSERT INTO CLIENTES VALUES (7002,'Jorge Rivera', 'H', 'Merlo');
INSERT INTO CLIENTES VALUES (7003,'Noelia Martinez', 'M', 'Ramos Mejía');
INSERT INTO CLIENTES VALUES (7004,'Ignacio Sanchez', 'H', 'Floresta');
INSERT INTO CLIENTES VALUES (7005,'Alan Chipana', 'H', 'Caballito');
INSERT INTO CLIENTES VALUES (7006,'Miguel Zalazar', 'H', 'Liniers');
INSERT INTO CLIENTES VALUES (7007,'Susana Contreras', 'M', 'Ciudadela');
INSERT INTO CLIENTES VALUES (7008,'Silvina Luna', 'M', 'San Antonio de Padua');
INSERT INTO CLIENTES VALUES (7009,'Juan Martin Lopez', 'H', 'Flores');
INSERT INTO CLIENTES VALUES (7010,'Priscila Lojo ', 'M', 'Villa Luro');
COMMIT;

--   -> INSERTS VENDEDORES (*CodV, NombV, SexoV, FnacV)
BEGIN TRANSACTION;
INSERT INTO VENDEDORES VALUES (501,'Gabriel Gómez', 'H', '1995-12-25');
INSERT INTO VENDEDORES VALUES (502,'Diego Paniagua', 'H', '1997-09-23');
INSERT INTO VENDEDORES VALUES (503,'Rocío Castro', 'M', '1973-03-12');
INSERT INTO VENDEDORES VALUES (504,'Domingo Díaz', 'H', '1989-01-06');
INSERT INTO VENDEDORES VALUES (505,'Marcelo Aguirre', 'H', '1985-02-28');
INSERT INTO VENDEDORES VALUES (506,'Damian Rodriguez', 'H', '1998-08-15');
INSERT INTO VENDEDORES VALUES (507,'Jonathan Aguirre', 'H', '1977-11-17');
INSERT INTO VENDEDORES VALUES (508,'Zunilda Galarza', 'M', '1997-10-05');
INSERT INTO VENDEDORES VALUES (509,'Facundo Pérez', 'H', '1995-7-22');
INSERT INTO VENDEDORES VALUES (510,'Nahuel Daubert ', 'H', '2000-06-16');
COMMIT;

--   -> INSERTS DEPARTAMENTOS (*CodD, NombD, Rubro)
BEGIN TRANSACTION;
INSERT INTO DEPARTAMENTOS VALUES (01,'RoperoStation', 'Ropa');
INSERT INTO DEPARTAMENTOS VALUES (02,'GastroStation', 'Gastronomia');
INSERT INTO DEPARTAMENTOS VALUES (03,'Matilda', 'Libreria');
INSERT INTO DEPARTAMENTOS VALUES (04,'Diamond System', 'Informatica');
INSERT INTO DEPARTAMENTOS VALUES (05,'Lonera Ituzaingo', 'Toldos');
COMMIT;

--   -> INSERTS PROVEEDORES (*Cuit, NombP, Direc, Localidad)
BEGIN TRANSACTION;
INSERT INTO PROVEEDORES VALUES('30389592885', 'La Tolderia', '3894 Martin Fierro', 'Ituzaingo');
INSERT INTO PROVEEDORES VALUES('30254097779', 'Toldos La Moderna', '751 Suipacha', 'Merlo');
INSERT INTO PROVEEDORES VALUES('30208985457', 'Margarita Margarina', '2525 Av.Calle De Las Flores', 'Ciudad Falsa');
INSERT INTO PROVEEDORES VALUES('30366669996', 'Papelera Freedy Mercury', '434 Av.Libertad', 'Merlo');
INSERT INTO PROVEEDORES VALUES('30267788991', 'Compra Gamer', null, null);
INSERT INTO PROVEEDORES VALUES('30429566599', 'Boligrafos Paso', '1435 Av.Jujuy', 'CABA');
INSERT INTO PROVEEDORES VALUES('30952365645', 'Indumentaria Vinson', null, 'Villa Bosh');
INSERT INTO PROVEEDORES VALUES('27356620009', 'Semillas del Hermitaño', '4476 Del Lazo', 'Ituzaingo');
COMMIT;

--   -> INSERTS ARTICULOS (*CodA, NombA, Precio, Stock, StockMin, StockMax, CodD)
BEGIN TRANSACTION;
INSERT INTO ARTICULOS VALUES (2001, 'Lapiz Negro', 10, 500, 200, 1000, 03);
INSERT INTO ARTICULOS VALUES (2002 ,'Camisa', 350, 150, 50, 200, 01);
INSERT INTO ARTICULOS VALUES (2003, 'Cuadernos', 80, 200, 50, 500, 03);
INSERT INTO ARTICULOS VALUES (2004, 'Hojas', 300, 100, 150, 1500, 03);
INSERT INTO ARTICULOS VALUES (2005, 'Pantalones', 700, 40, 50, 450, 01);
INSERT INTO ARTICULOS VALUES (2006, 'Torta', 500, 15, 5, 30, 02);
INSERT INTO ARTICULOS VALUES (2007, 'Sandwich de Miga', 20, 200, 150, 600, 02);
INSERT INTO ARTICULOS VALUES (2008, 'Notebook', 15000, 30, 20, 90, 04);
INSERT INTO ARTICULOS VALUES (2009, 'Monitor 30°', 9000, 20, 25, 90, 04);
INSERT INTO ARTICULOS VALUES (2010, 'Lona 1x2m', 100, 300, 50, 400, 05);
INSERT INTO ARTICULOS VALUES (2011, 'Toldo Rebatible', 300, 73, 50, 200, 05);
INSERT INTO ARTICULOS VALUES (2012, 'Remeras', 250, 75, 50, 300, 01);
INSERT INTO ARTICULOS VALUES (2013, 'Alfajor Integral', 60, 30, 20, 100, 02);
INSERT INTO ARTICULOS VALUES (2014, 'Toldo tela Plastica', 250, 60, 50, 200, 05);
COMMIT;

--   -> INSERTS ENTREGA (*CodA, *Cuit, *FechaE, PrecioAdq, CantE)
BEGIN TRANSACTION;
INSERT INTO ENTREGAS VALUES (2001,'30429566599', '2017-02-28', 500, 40);
INSERT INTO ENTREGAS VALUES (2002,'30952365645', '2014-03-05', 750, 97);
INSERT INTO ENTREGAS VALUES (2003,'30366669996', '2016-05-12', 359, 35);
INSERT INTO ENTREGAS VALUES (2004,'30366669996', '2016-05-12', 932, 32);
INSERT INTO ENTREGAS VALUES (2005,'30952365645', '2018-12-29', 1000, 15);
INSERT INTO ENTREGAS VALUES (2006,'30208985457', '2019-10-17', 1300, 20);
INSERT INTO ENTREGAS VALUES (2007,'27356620009', '2015-04-19', 270, 90);
INSERT INTO ENTREGAS VALUES (2008,'30267788991', '2017-03-09', 135, 120);
INSERT INTO ENTREGAS VALUES (2009,'30267788991', '2017-03-09', 875, 150);
INSERT INTO ENTREGAS VALUES (2010,'30389592885', '2018-12-19', 1780, 80);
INSERT INTO ENTREGAS VALUES (2011,'30389592885', '2018-12-19', 410, 22);
INSERT INTO ENTREGAS VALUES (2012,'30952365645', '2008-07-06', 2700, 54);
INSERT INTO ENTREGAS VALUES (2013,'27356620009', '2005-09-14', 449, 45);
INSERT INTO ENTREGAS VALUES (2014,'30254097779', '2002-11-16', 95, 200);
INSERT INTO ENTREGAS VALUES (2010,'30389592885', '2015-10-29', 47, 120);
INSERT INTO ENTREGAS VALUES (2011,'30389592885', '2015-10-29', 820, 100);
INSERT INTO ENTREGAS VALUES (2007,'27356620009', '2012-08-31', 400, 40);
INSERT INTO ENTREGAS VALUES (2012,'30952365645', '2019-09-30', 150, 25);
COMMIT;

--   -> INSERTS FACTURAS (*CodF, *CodC, *CodV, FechaV)
BEGIN TRANSACTION;
INSERT INTO FACTURAS VALUES (101, 7001, 501, '2018-3-25'); --Factura 101 al 103 para art de ropa
INSERT INTO FACTURAS VALUES (102, 7001, 504, '2019-3-5');
INSERT INTO FACTURAS VALUES (103, 7001, 508, '2019-3-14');
INSERT INTO FACTURAS VALUES (104, 7001, 503, '2019-7-18'); --Factura 104 y 105 con mas de 10 art
INSERT INTO FACTURAS VALUES (105, 7002, 510, '2019-7-18');
INSERT INTO FACTURAS VALUES (106, 7002, 510, '2019-9-18'); --Factura 106 con menos de 10 art
INSERT INTO FACTURAS VALUES (107, 7002, 509, '2019-2-18'); --Factura 107 al 109 con muchos lapices negros
INSERT INTO FACTURAS VALUES (108, 7009, 505, '2019-3-10');
INSERT INTO FACTURAS VALUES (109, 7009, 502, '2018-3-10');
INSERT INTO FACTURAS VALUES (110, 7010, 506, '2018-3-12'); --Factura 110 al 112 para art de ropa
INSERT INTO FACTURAS VALUES (111, 7010, 507, '2019-3-1');
INSERT INTO FACTURAS VALUES (112, 7008, 508, '2019-3-30');
INSERT INTO FACTURAS VALUES (113, 7007, 510, '2018-3-4'); --Factura 113 al 115 con art 2010-2011-2014
INSERT INTO FACTURAS VALUES (114, 7003, 501, '2019-7-10');
INSERT INTO FACTURAS VALUES (115, 7004, 501, '2019-7-18'); -- mas de 10 art
COMMIT;

--   -> INSERTS CONTIENE (*CodA, *CodF, PrecioVent, Cant)
BEGIN TRANSACTION;
INSERT INTO CONTIENE VALUES (2002, 101, 600, 3); -- 101 a 103 solo art. de ropa
INSERT INTO CONTIENE VALUES (2005, 101, 600, 2); -- 101
INSERT INTO CONTIENE VALUES (2012, 101, 200, 1); -- 101
INSERT INTO CONTIENE VALUES (2005, 102, 400, 4); -- 102
INSERT INTO CONTIENE VALUES (2012, 103, 200, 5); -- 103
INSERT INTO CONTIENE VALUES (2001, 104, 2500, 15); -- 104 y 105 con mas de 10 art.
INSERT INTO CONTIENE VALUES (2012, 104, 2500, 30); --104
INSERT INTO CONTIENE VALUES (2002, 105, 200, 4); -- 105
INSERT INTO CONTIENE VALUES (2012, 105, 200, 4); -- 105
INSERT INTO CONTIENE VALUES (2003, 105, 2000, 8); -- 105
INSERT INTO CONTIENE VALUES (2006, 106, 120, 2); -- 106 con menos de 10 art.
INSERT INTO CONTIENE VALUES (2005, 106, 60, 1); -- 106
INSERT INTO CONTIENE VALUES (2001, 107, 300, 20); -- 107 a 109 muchos lapices negros
INSERT INTO CONTIENE VALUES (2001, 108, 600, 40); -- 108
INSERT INTO CONTIENE VALUES (2003, 108, 350, 5); -- 108
INSERT INTO CONTIENE VALUES (2001, 109, 150, 10); -- 109
INSERT INTO CONTIENE VALUES (2004, 109, 2500, 5); -- 109
INSERT INTO CONTIENE VALUES (2002, 110, 1200, 10); -- 110 para ropa y otros
INSERT INTO CONTIENE VALUES (2012, 110, 1900, 14); -- 110
INSERT INTO CONTIENE VALUES (2003, 110, 1900, 14); -- 110
INSERT INTO CONTIENE VALUES (2004, 110, 1900, 14); -- 110
INSERT INTO CONTIENE VALUES (2012, 111, 2050, 14); -- 111
INSERT INTO CONTIENE VALUES (2005, 111, 80, 1); -- 111
INSERT INTO CONTIENE VALUES (2005, 112, 500, 5); -- 112 solo un articulo de ropa
INSERT INTO CONTIENE VALUES (2010, 113, 2500, 4); -- 113 a 115 art. relacionados con el PRO: La Tolderia
INSERT INTO CONTIENE VALUES (2011, 114, 4000, 6); -- 114
INSERT INTO CONTIENE VALUES (2014, 115, 1250, 2); -- 115
INSERT INTO CONTIENE VALUES (2004, 115, 3600, 12); -- 115
COMMIT;

-- ------------CONSULTAS
-- 1 Listar los datos completos de los vendedores hombres que vendieron más de 
-- 10 artículos el 18 de Julio de este año
SELECT *
FROM VENDEDORES V
WHERE SEXOV='H' AND 10<(     	--Cantidad de articulos vendidos por el vendedor:
	SELECT SUM(CANT) 	--SUMA entre CANTIDAD de articulos vendidos por VENDEDOR
	FROM FACTURAS F, CONTIENE C 	--Prod Cart
	WHERE F.Codf=C.CodF	--JOIN
    	AND V.CodV=F.CodV	--Asegurarse de que se trate del mismo Vendedor
    	AND FechaV = '18-7-2019')	--Restriccion por Fecha

--2 Listar los datos completos de los clientes que compraron todos los artículos 
-- del rubro "Ropa" 
SELECT DISTINCT CLI.* 
FROM CLIENTES CLI 
WHERE NOT EXISTS( --clientes que no esten en los 
	SELECT 1
	FROM ARTICULOS A
	WHERE A.CodD IN (SELECT CodD FROM DEPARTAMENTOS D WHERE RUBRO ILIKE 'ROPA')
	--Articulos de rubro ropa
	AND NOT EXISTS( -- que no esten en 
		SELECT 1
		FROM FACTURAS F1 INNER JOIN CONTIENE C ON F1.CodF=C.CodF
		--join de facturas con contiene
		WHERE A.CodA=C.CodA --mismo articulo
		AND CLI.CodC=F1.CodC)) --mismo cliente

--3 Listar los datos completos de los vendedores que no vendieron ningun articulo 
-- provistos por el proveedor "La Tolderia"
SELECT *
FROM VENDEDORES
WHERE CodV NOT IN( -- Vendedores que no esten en:
	SELECT CodV
	FROM FACTURAS F, CONTIENE C, ENTREGAS E, PROVEEDORES P -- Prod Cart
	WHERE F.CodF=C.CodF AND C.CodA=E.CodA AND E.Cuit=P.Cuit -- JOIN
	AND P.NombP ILIKE 'LA TOLDERIA') --Restriccion por Nombre de Proveedor

--4 Listar los datos completos de los clientes que compraron más cantidad del 
-- articulo "Lapiz Negro" que la cantidad total de artículos vendidos el 
-- 18 de Febrero de este año
SELECT C.*
FROM CLIENTES C, FACTURAS F, CONTIENE C1
WHERE C.CODC=F.CODC AND F.CODF=C1.CODF --JOIN entre las 3 relaciones
AND C1.CODA=(
SELECT CODA  --donde el articulo sea lapiz negro
	FROM ARTICULOS 
	WHERE NOMBA ILIKE 'LAPIZ NEGRO')
GROUP BY C.CODC
HAVING SUM(C1.CANT)>(
SELECT SUM(C2.CANT)  --y que la cantidad sea mayor a los articulos vendidos
	FROM FACTURAS F1, CONTIENE C2 
	WHERE F1.CODF=C2.CODF AND F1.FECHAV='2019-2-18')-- en esta fecha

--5 Listar el nombre de cada departamento y en la misma línea 
-- el total de artículos vendidos en Marzo de este año y en Marzo 
--del año pasado
SELECT TABLA1.NombD, TABLA2.Marzo2019, TABLA3.Marzo2018
FROM (SELECT CodD, NombD FROM DEPARTAMENTOS) as TABLA1
 FULL JOIN
	(SELECT D.CodD, D.NombD, SUM(X.Cant) Marzo2019
	 FROM (DEPARTAMENTOS D INNER JOIN ARTICULOS A ON A.CodD=D.CodD) 
	 LEFT JOIN
	   (SELECT C.CodA, C.Cant FROM CONTIENE C,FACTURAS F
	   WHERE C.CodF=F.CodF AND F.FechaV BETWEEN '2019-3-1' AND '2019-3-31') as X
	 ON A.CodA=X.CodA
	 GROUP BY D.CodD) as TABLA2
ON TABLA1.CodD=TABLA2.CodD
FULL JOIN
	(SELECT D1.CodD, D1.NombD, SUM(X1.Cant) Marzo2018
	FROM (DEPARTAMENTOS D1 INNER JOIN ARTICULOS A1 ON A1.CodD=D1.CodD) 
	LEFT JOIN
	  (SELECT C1.CodA, C1.Cant FROM CONTIENE C1,FACTURAS F1
	  WHERE C1.CodF=F1.CodF AND F1.FechaV BETWEEN '2018-3-1' AND '2018-3-31') as X1
	ON A1.CodA=X1.CodA
	GROUP BY D1.CodD) as TABLA3
ON TABLA3.CodD=TABLA2.CodD
